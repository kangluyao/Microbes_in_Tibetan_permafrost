---
title: "Analysis for revision"
author: "Luyao Kang"
date: "`r Sys.Date()`"
output:
  html_notebook:
    toc: yes
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```{r setup, include = F}
knitr::opts_chunk$set(
  collapse = T, echo = T, comment = "#>", message = F, warning = F,
	fig.align = "center", fig.width= 4.5, fig.height = 3, dpi = 150)
```
## Data input 
Set work and saving directory
```{r}
wd <- 'e:/permafrost'
setwd(wd)
save.dir.revision <- file.path(wd,"revision/results")
if (!dir.exists(save.dir.revision)) {
  dir.create(save.dir.revision)
}
```

## Reading data
```{r}
HF_df <- read.table(file = file.path(wd, 'revision/data/HF.csv'),
                           sep = ',',  header = T, stringsAsFactors = F)
```
Test the human disturbance on the Tibetan plateau
```{r}
# plot
library(gghalves)
main_theme = theme_bw() + 
  theme(panel.grid = element_blank(),
        panel.border = element_rect(size = 0.5),
        strip.text = element_text(colour = 'black', size = 7),
        strip.background = element_rect(colour = 'black', fill = 'grey'),
        axis.title = element_text(color = 'black',size = 7),
        axis.ticks = element_line(color = "black", linewidth = 0.5),
        axis.text.y = element_text(colour = 'black', size = 6),
        axis.text.x = element_text(colour = 'black', size = 6),
        legend.title = element_text(colour = 'black', size = 7),
        legend.text = element_text(colour = 'black', size = 6),
        legend.key.size = unit(0.5, 'cm'))
my_comparisons <- list(c('Sampling_sites', 'Cities'))
p1 <- HF_df %>%
  mutate(Type = factor(Type, levels = c("Sampling_sites", "Cities"))) %>%
  ggplot(aes(Type, HF_2000_2015, fill = Type)) +
  geom_boxplot(width = 0.4, size = 0.75, outlier.color = NA) +
  geom_jitter(aes(fill = Type), shape = 21, size = 1.5, width = 0.2) +
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.1))) +
  scale_x_discrete(labels = c("Sampling_sites" = "Sampling sites", "Cities" = "Cities")) +
  stat_compare_means(comparisons = my_comparisons, paired = F,
                     p.adjust.method = "BH", label = "p.signif", bracket.size = 0.3,
                     size = 3.5, tip.length = 0.00, method = "wilcox.test") +
  labs(x = NULL, y = "Human footprint index") +
  scale_fill_manual(values = c("#f8766d", "#a3a500")) +
  main_theme + theme(legend.position = "none")
# save plot
# ggsave(file.path(save.dir.revision, "./HF.pdf"), p1, width = 3.5, height = 2.5, units = "in")
p1
```

## Explor the phylogenecy of specific taxonomic groups and comparing the phylogenetic difference among layers
```{r}
# First, we want to know which taxonomic groups are dominant taxa in our samples


```

```{r}
# write a function for data organization
arrange.tab <- function(phylo, N, taxrank, vect) {
  subphylo <- tax_glom(phylo, taxrank)
  subphylo.rel <- microbiome::transform(subphylo, "compositional")
  ra.tab <- otu_table(subphylo.rel)
  MRA <- rowMeans(ra.tab)
  group <- tax_table(subphylo.rel)[,vect]
  mra.tab <- data.frame(group,MRA)
  colnames(mra.tab) <- c('level1', 'level2', 'MRA')
  #arrange the class table
  mra.tab_level1 = mra.tab %>% group_by(level1) %>% 
    summarise(sum_MRA = sum(MRA)) %>% 
    arrange(desc(sum_MRA))
  top_N_level1 = mra.tab_level1[1:N, ]$'level1'
  top_N_tab = mra.tab[mra.tab$'level1' %in% top_N_level1, ]
  mra.tab_level2 = top_N_tab %>% group_by(level2) %>% 
    summarise(sum_MRA = sum(MRA)) %>% 
    arrange(desc(sum_MRA))
  order_level2 = mra.tab_level2$'level2'
  top_N_tab$'level1' = factor(top_N_tab$'level1', ordered = T, levels = top_N_level1)
  top_N_tab$'level2' = factor(top_N_tab$'level2', ordered = T, levels = rev(order_level2))
  top_N_tab$MRA = top_N_tab$MRA*100
  return(top_N_tab)
}
```
Determine the relative abundance of the taxa at the phylum level.
```{r}
top10family <- arrange.tab(phylo, 10, 'Family', c(5,7))
mra.tab_level1 = top10family %>% group_by(level1) %>% 
  summarise(sum_MRA = sum(MRA)) %>% 
  arrange(desc(sum_MRA)) %>%
  dplyr::rename(Family = level1, prop = sum_MRA) %>%
  bind_rows(summarise_all(., ~if(is.numeric(.)) 100-sum(.) else "Others"))
mra.tab_level1
```
## Extract the phylogenetic trees of the top 5 familys
```{r}
fam_names <- c("KD4-96", "Defluviicoccaceae", "67-14", "Nitrosomonadaceae", "Comamonadaceae")
kd4_96_phylo <- subset_taxa(phylo, Family == "KD4-96")
kd4_96_tree <- phy_tree(kd4_96_phylo)
Deflu_phylo <- subset_taxa(phylo, Family == "Defluviicoccaceae")
Deflu_tree <- phy_tree(Deflu_phylo)
fam67_14_phylo <- subset_taxa(phylo, Family == "67-14")
fam67_14_tree <- phy_tree(fam67_14_phylo)
Nitro_phylo <- subset_taxa(phylo, Family == "Nitrosomonadaceae")
Nitro_tree <- phy_tree(Nitro_phylo)
Comamo_phylo <- subset_taxa(phylo, Family == "Comamonadaceae")
Comamo_tree <- phy_tree(Comamo_phylo)
# plot the trees
library(ape)
library(ggplot2)
library("phytools") # for sims and ASRs
library("ggtree")
g1 <- ggtree(kd4_96_tree, layout = 'circular', open.angle = 20)
g2 <- ggtree(Deflu_tree, layout = 'circular', open.angle = 20)
g3 <- ggtree(fam67_14_tree, layout = 'circular', open.angle = 20)
g4 <- ggtree(Nitro_tree, layout = 'circular', open.angle = 20)
g5 <- ggtree(Comamo_tree, layout = 'circular', open.angle = 20)
cowplot::plot_grid(g1, g2, g3, g4, g5, nrow = 2)
```
## Determine the phylogenitic distance between clades within each site among three layers
```{r}
# here we use mean pairwise distance to measure the phylogenetic distance between clades within samples
pd_kd4_96 <- mpd(t(data.frame(otu_table(kd4_96_phylo))), cophenetic(kd4_96_tree), abundance.weighted = F)
pd_Deflu <- mpd(t(data.frame(otu_table(Deflu_phylo))), cophenetic(Deflu_tree), abundance.weighted = F) 
pd_67_14 <- mpd(t(data.frame(otu_table(fam67_14_phylo))), cophenetic(fam67_14_tree), abundance.weighted = F) 
pd_Nitro <- mpd(t(data.frame(otu_table(Nitro_phylo))), cophenetic(Nitro_tree), abundance.weighted = F) 
pd_Comamo <- mpd(t(data.frame(otu_table(Comamo_phylo))), cophenetic(Comamo_tree), abundance.weighted = F) 

pd_top5 <- data.frame(Layers = metadata$Layer, kd4_96 = pd_kd4_96, Deflu = pd_Deflu, fam67_14 = pd_67_14, Nitro = pd_Nitro, Comamo = pd_Comamo)

# Box plot for evenness index using ggplot2
rep_str = c("kd4_96" = "KD4-96",
            "Deflu" = "Defluviicoccaceae",
            "fam67_14" = "67-14",
            "Nitro" = "Nitrosomonadaceae",
            "Comamo" = "Comamonadaceae")
# write a function to change the facet labels
facet_labeller <- function(variable,value){
  return(rep_str[value])
}

library(ggpubr)
library(ggplot2)
my_comparisons <- list( c("SUR", "SUB"), c("SUB", "PL"), c("SUR", "PL"))
MPD_top5 <- pd_top5 %>%
  pivot_longer(-c(Layers), names_to = "Family", values_to = "MPD") %>%
  mutate(Layers = factor(Layers, levels = c("SUR", "SUB", "PL"))) %>%
  mutate(Family = factor(Family, levels = c("kd4_96", "Deflu", "fam67_14", "Nitro", "Comamo"))) %>%
  ggplot(aes(x = Layers, y = MPD)) + 
  geom_boxplot(width = 0.5, aes(fill = Layers)) +
  facet_wrap(. ~ Family, scales = 'free', labeller = facet_labeller) +
  scale_fill_manual(values = c("#f8766d", "#a3a500", "#00b0f6")) +
  stat_compare_means(comparisons = my_comparisons, paired = TRUE, 
                     p.adjust.method = "BH", label = "p.signif", 
                     na.rm = T, size = 2.5) +
  #scale_fill_manual(values= cols)+
  labs(x = 'Layers', y = 'Mean pairwise distance', fill='Layers') +
  main_theme + theme(legend.position = "none", panel.spacing = unit(0.5, "lines"))
# save plot
ggsave(file.path(save.dir.revision, "./MPD.pdf"), MPD_top5, width = 6, height = 4.5, units = "in")
MPD_top5
```


